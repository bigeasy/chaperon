<!DOCTYPE html>

<html>
<head>
  <title>gatherer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="chaperon.bin.js.html">
                  chaperon.bin.js
                </a>


                <a class="source" href="chaperon.js.html">
                  chaperon.js
                </a>


                <a class="source" href="colleagues.js.html">
                  colleagues.js
                </a>


                <a class="source" href="gatherer.js.html">
                  gatherer.js
                </a>


                <a class="source" href="recoverable.js.html">
                  recoverable.js
                </a>


                <a class="source" href="unrecoverable.js.html">
                  unrecoverable.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>gatherer.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Return the first not null-like value.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> coalesce = <span class="hljs-built_in">require</span>(<span class="hljs-string">'extant'</span>)

</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Determine when the population has settled down.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Uptime = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mingle.uptime'</span>)

</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Most-recently used cache.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Cache = <span class="hljs-built_in">require</span>(<span class="hljs-string">'magazine'</span>)

<span class="hljs-keyword">var</span> recoverable = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./recoverable'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Gatherer</span> (<span class="hljs-params">options</span>) </span>{
    options = coalesce(options, {})
    <span class="hljs-keyword">this</span>._uptimes = <span class="hljs-keyword">new</span> Cache().createMagazine()
    <span class="hljs-keyword">this</span>._Date = coalesce(options.Date, <span class="hljs-built_in">Date</span>)
    <span class="hljs-keyword">this</span>._stableAfter = options.stableAfter
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">group</span> (<span class="hljs-params">groupBy, collection, list</span>) </span>{
    <span class="hljs-keyword">var</span> groups = {}, array = []
    list.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">element</span>) </span>{
        <span class="hljs-keyword">var</span> group = array.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">group</span>) </span>{
            <span class="hljs-keyword">return</span> group[groupBy] == element[groupBy]
        }).shift()
        <span class="hljs-keyword">if</span> (!group) {
            group = {}
            group[groupBy] = element[groupBy]
            group[collection] = []
            array.push(group)
        }
        group[collection].push(element)
    })
    groups.array = array
    groups.map = {}
    groups.null = <span class="hljs-literal">null</span>
    groups.array.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">group</span>) </span>{
        <span class="hljs-keyword">if</span> (group[groupBy] == <span class="hljs-literal">null</span>) {
            groups.null = group
        } <span class="hljs-keyword">else</span> {
            groups.map[group[groupBy]] = group
        }
    }, groups)
    <span class="hljs-keyword">return</span> groups
}

Gatherer.prototype.gather = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleagues</span>) </span>{
    <span class="hljs-keyword">var</span> islands = group(<span class="hljs-string">'island'</span>, <span class="hljs-string">'colleagues'</span>, colleagues).map
    <span class="hljs-keyword">var</span> gathered = {}
</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Deterimine the actions for each island.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> islandName <span class="hljs-keyword">in</span> islands) {
        <span class="hljs-keyword">var</span> island = islands[islandName]
        gathered[islandName] = {
            <span class="hljs-attr">name</span>: islandName,
            <span class="hljs-attr">stable</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">okay</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">uninitialized</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">recoverable</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">unrecoverable</span>: <span class="hljs-literal">null</span>
        }
</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>See if the colleagues that make up this island have stabilized.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> uptime = <span class="hljs-keyword">this</span>._uptimes.get(island.island, <span class="hljs-keyword">new</span> Uptime({ <span class="hljs-attr">Date</span>: <span class="hljs-keyword">this</span>._Date }))
        <span class="hljs-keyword">if</span> (uptime.calculate(island.colleagues) &lt; <span class="hljs-keyword">this</span>._stableAfter) {
            <span class="hljs-keyword">continue</span>
        }
        gathered[islandName].stable = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">var</span> republics = group(<span class="hljs-string">'republic'</span>, <span class="hljs-string">'colleagues'</span>, island.colleagues).array
        gathered[islandName].uninitialized = republics.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">republic</span>) </span>{
            <span class="hljs-keyword">return</span> republic.republic == <span class="hljs-literal">null</span>
        })
        <span class="hljs-keyword">var</span> republics = republics.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">republic</span>) </span>{
            <span class="hljs-keyword">return</span> republic.republic != <span class="hljs-literal">null</span>
        })
</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>We’re going to assume that we would not have started a new republic
if the old was had become unrecoverable. Could be a chance that we
actually have two functioning republics, so we’d want to make log
this state since it is split brain. I’ve not seen it in the wild yet
so I’m not overly converned about it at the moment.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        gathered[islandName].recoverable = republics.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">republic</span>) </span>{
            <span class="hljs-keyword">return</span> republic.recoverable = recoverable(republic.colleagues)
        })
        gathered[islandName].unrecoverable = republics.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">republic</span>) </span>{
            <span class="hljs-keyword">return</span> ! republic.recoverable
        })
    }
    <span class="hljs-keyword">this</span>._uptimes.expire(<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">15</span>)
    <span class="hljs-keyword">return</span> gathered
}

<span class="hljs-built_in">module</span>.exports = Gatherer

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
