<!DOCTYPE html>

<html>
<head>
  <title>chaperon.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="chaperon.bin.js.html">
                  chaperon.bin.js
                </a>


                <a class="source" href="chaperon.js.html">
                  chaperon.js
                </a>


                <a class="source" href="colleagues.js.html">
                  colleagues.js
                </a>


                <a class="source" href="gatherer.js.html">
                  gatherer.js
                </a>


                <a class="source" href="recoverable.js.html">
                  recoverable.js
                </a>


                <a class="source" href="unrecoverable.js.html">
                  unrecoverable.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>chaperon.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Last time you came back to this project, you couldn’t understand why it is a
separate process and not a library run by the Colleague. No reason. Only that
it is doing something rather different, so it may as well run in it’s own
process, because with Node.js processes are like threads. If there is a
problem with discovery, in production, we’ll see problems with this process
and not with the colleague or the procsses it monitors.</p>
<p>It’s seperate because it is a seperate utility. It runs in it’s own process.
It uses HTTP because that’s our default RPC protocol.</p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>

            </div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Common utilities.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> coalesce = <span class="hljs-built_in">require</span>(<span class="hljs-string">'extant'</span>)
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)

<span class="hljs-keyword">var</span> ascension = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ascension'</span>)

</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Control-flow utilities.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)

<span class="hljs-keyword">var</span> Monotonic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'monotonic'</span>).asString


<span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'prolific.logger'</span>).createLogger(<span class="hljs-string">'chaperon'</span>)
<span class="hljs-keyword">var</span> unrecoverable = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./unrecoverable'</span>)
<span class="hljs-keyword">var</span> recoverable = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./recoverable'</span>)

<span class="hljs-keyword">var</span> Uptime = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mingle.uptime'</span>)

</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Bind an object to Sencha Connect middleware.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Reactor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'reactor'</span>)

</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Most-recently used cache.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Cache = <span class="hljs-built_in">require</span>(<span class="hljs-string">'magazine'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Chaperon</span> (<span class="hljs-params">options</span>) </span>{
    <span class="hljs-keyword">this</span>._colleagues = options.colleagues
    <span class="hljs-keyword">this</span>._stableAfter = options.stableAfter
    <span class="hljs-keyword">this</span>._Date = coalesce(options.Date, <span class="hljs-built_in">Date</span>)
    <span class="hljs-keyword">this</span>._uptimes = <span class="hljs-keyword">new</span> Cache().createMagazine()
    <span class="hljs-keyword">this</span>.reactor = <span class="hljs-keyword">new</span> Reactor(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dispatcher</span>) </span>{
        dispatcher.dispatch(<span class="hljs-string">'GET /'</span>, <span class="hljs-string">'index'</span>)
        dispatcher.dispatch(<span class="hljs-string">'POST /action'</span>, <span class="hljs-string">'action'</span>)
        dispatcher.dispatch(<span class="hljs-string">'GET /health'</span>, <span class="hljs-string">'health'</span>)
    })
}

Chaperon.prototype.index = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> [ <span class="hljs-number">200</span>, { <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'text/plain'</span> }, <span class="hljs-string">'Compassion Chaperon API\n'</span> ]
})

<span class="hljs-keyword">var</span> byStartedAtThenId = ascension([ <span class="hljs-built_in">Number</span>, <span class="hljs-built_in">String</span> ], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">object</span>) </span>{
    <span class="hljs-keyword">return</span> [ object.startedAt, object.id ]
})

</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The chaperon is going to make a best effort get newly booted islanders onto
an island, or to get a newly booted islander to form an island if none
exists. It takes the place of the sysadmin that would issue commands to
bootstrap a new consensus and to tell new participants to join an existing
consensus. It is not meant to be a consensus alogrithm in itself. It cannot
make intelligent decisions about all failure cases.</p>
<p>The chaperon polls the discovery end point to get a collection of network
conduits. It then polls the network conduits to get a collection of
partipants. It waits for a while to ensure that that the collection of
participants is stable. It then makes a decision based on what the
participants have to say for themselves.</p>
<p>If the chaperon cannot get a healthy response from all the network conduits
then it will not make a decision and instead wait for the network conduits to
become stable.</p>
<p>We are going to poll every member returned by discovery, so if the list of
network conduits returned discovery endpoint is missing a conduit, the
chaperon is going to make a bad decision.</p>
<p>TODO Split brain is unrecoverable. The Chaperon will detect it. It is an
unlikely state, it seems, but I’m not certain. It is definately a possiblity
if the discovery end point returns an incomplete list of network conduits.
We’re probably going to want to look for this state in the logs in case we
miss it in the chaperon.</p>
<p>TODO Describe the <code>rejoining</code> property which will cause the chaperon to halt
if it the chaperon is either forming a new consensus or if the consensus id
is not the same as the consensus id indicated by the <code>rejoining</code> property.</p>
<p>TODO Clever word for <code>uninitialized</code> which could be instead <code>booted</code> or
<code>arriving</code> or something.</p>

            </div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Chaperon.prototype._actions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">islands</span>) </span>{
    <span class="hljs-keyword">var</span> actions = {}
</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Chose an action for each island. A null list of actions indicates that
the island has halted.</p>

            </div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> islands) {
        <span class="hljs-keyword">var</span> island = islands[name]

</pre></div></div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>An array of actions to take keyed by island name.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        actions[name] = []

</pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>If the island is not stable there is no action to take.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!island.stable) {
            <span class="hljs-keyword">continue</span>
        }

</pre></div></div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>If the there are no current recoverable consensuses then we are going
to bootstrap a new conensus.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (island.recoverable.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> (island.uninitialized.length != <span class="hljs-number">0</span>) {
</pre></div></div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>If anyone of are participants believes it is going to rejoin an
existing consensus then we halt.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (island.uninitialized[<span class="hljs-number">0</span>].colleagues.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague</span>) </span>{
                    <span class="hljs-keyword">return</span> colleague.rejoining != <span class="hljs-literal">null</span>
                }).length != <span class="hljs-number">0</span>) {
                    actions[name] = <span class="hljs-literal">null</span>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> oldest = island.uninitialized[<span class="hljs-number">0</span>].colleagues.slice().sort(byStartedAtThenId).shift()
                    actions[name].push({ <span class="hljs-attr">action</span>: <span class="hljs-string">'bootstrap'</span>, <span class="hljs-attr">colleague</span>: oldest })
                }
            }
</pre></div></div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>This is split brain. Not really sure what the right answer is. It
is a bad state that has different meanings for different
applications.</p>
<p>Split brain could occur if an entire island is unreachable to the
Chaperon when a new participant arrives. That new participant
would become a dictator. The missing island becomes reachable and
now we have a split brain. This is unlikely on a local network,
so I don’t have any real world experience with it.</p>
<p>For now we are going to return halted and count on our
environment to handle this, maybe by waking the admin.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (island.recoverable.length &gt; <span class="hljs-number">1</span>) {
            actions[name] = <span class="hljs-literal">null</span>
</pre></div></div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>TODO (Not true yet.) Otherwise we should tell any arriving
participants to join the current consensus. We tell the participant
to join by messaging the leader. This is a race condition since
leadership can change. If the consensus is under new leadership when
the participant trys to arrive it will crash restart.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
            island.uninitialized.length != <span class="hljs-number">0</span> &amp;&amp;
            island.uninitialized[<span class="hljs-number">0</span>].colleagues.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague</span>) </span>{
                <span class="hljs-keyword">return</span> !(
                    colleague.rejoining == <span class="hljs-literal">null</span> ||
                    colleague.rejoining == island.recoverable[<span class="hljs-number">0</span>].republic
                )
            }).length != <span class="hljs-number">0</span>
        ) {
            actions[name] = <span class="hljs-literal">null</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> leaderId = island.recoverable[<span class="hljs-number">0</span>].colleagues.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>{
                <span class="hljs-keyword">return</span> Monotonic.compare(b.government.promise, a.government.promise)
            })[<span class="hljs-number">0</span>].government.majority[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">var</span> leader = island.recoverable[<span class="hljs-number">0</span>].colleagues.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague</span>) </span>{
                <span class="hljs-keyword">return</span> colleague.id == leaderId
            }).shift()
            island.uninitialized[<span class="hljs-number">0</span>].colleagues.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague</span>) </span>{
                actions[name].push({
                    <span class="hljs-attr">action</span>: <span class="hljs-string">'join'</span>,
                    <span class="hljs-attr">republic</span>: leader.republic,
                    <span class="hljs-attr">url</span>: {
                        <span class="hljs-attr">self</span>: colleague.url,
                        <span class="hljs-attr">leader</span>: leader.url
                    },
                    <span class="hljs-attr">colleague</span>: colleague
                })
            })
        }
    }
    <span class="hljs-keyword">return</span> actions
}

Chaperon.prototype.action = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, request</span>) </span>{
    <span class="hljs-keyword">var</span> colleagues = {}
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._colleagues.get(<span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleagues</span>) </span>{
        logger.info(<span class="hljs-string">'request'</span>, { <span class="hljs-attr">$colleagues</span>: colleagues, <span class="hljs-attr">$request</span>: request.body })
        <span class="hljs-keyword">var</span> action = <span class="hljs-keyword">this</span>._action(colleagues, request.body)
        logger.info(<span class="hljs-string">'action'</span>, { <span class="hljs-attr">$action</span>: action, <span class="hljs-attr">copacetic</span>: !! action.copacetic })
        <span class="hljs-keyword">return</span> action
    })
})

Chaperon.prototype.health = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> health = { <span class="hljs-attr">http</span>: <span class="hljs-keyword">this</span>.reactor.turnstile.health }
    logger.info(<span class="hljs-string">'health'</span>, health)
    <span class="hljs-keyword">return</span> health
})

<span class="hljs-built_in">module</span>.exports = Chaperon

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
