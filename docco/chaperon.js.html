<!DOCTYPE html>

<html>
<head>
  <title>chaperon.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="chaperon.bin.js.html">
                  chaperon.bin.js
                </a>


                <a class="source" href="chaperon.js.html">
                  chaperon.js
                </a>


                <a class="source" href="immigration.js.html">
                  immigration.js
                </a>


                <a class="source" href="transform.js.html">
                  transform.js
                </a>


                <a class="source" href="unrecoverable.js.html">
                  unrecoverable.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>chaperon.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Last time you came back to this project, you couldn’t understand why it is a
separate process and not a library run by the Colleague. No reason. Only tha
it is doing something rather different, so it may as well run in it’s own
process, because with Node.js processes are like threads. If there is a
problem with discovery, in production, we’ll see problems with this process
and not with the colleague or the procsses it monitors.</p>
<p>It’s seperate because it is a seperate utility. It runs in it’s own process.
It uses HTTP because that’s our default RPC protocol.</p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>

            </div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO Things like this need a careful name auditing.
TODO What is that supposed to mean; “name auditing?”</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'prolific.logger'</span>).createLogger(<span class="hljs-string">'chaperon'</span>)
<span class="hljs-keyword">var</span> unrecoverable = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./unrecoverable'</span>)
<span class="hljs-keyword">var</span> immigration = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./immigration'</span>)
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
<span class="hljs-keyword">var</span> transform = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./transform'</span>)
<span class="hljs-keyword">var</span> concat = [].conca
<span class="hljs-keyword">var</span> log = logger.trace.bind(logger)
<span class="hljs-keyword">var</span> Monotonic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'monotonic'</span>).asString
<span class="hljs-keyword">var</span> Dispatcher = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inlet/dispatcher'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Chaperon</span> (<span class="hljs-params">ua, uptime, health</span>) </span>{
    <span class="hljs-keyword">this</span>._ua = ua
    <span class="hljs-keyword">this</span>._uptime = uptime
    <span class="hljs-keyword">this</span>._stableAfter = <span class="hljs-number">900</span>
    <span class="hljs-keyword">this</span>._duraiton = <span class="hljs-number">0</span>
    <span class="hljs-keyword">this</span>._stability = {}
    <span class="hljs-keyword">this</span>._health = health
    <span class="hljs-keyword">this</span>._participating = {}
    <span class="hljs-keyword">var</span> dispatcher = <span class="hljs-keyword">new</span> Dispatcher(<span class="hljs-keyword">this</span>)
    dispatcher.dispatch(<span class="hljs-string">'GET /'</span>, <span class="hljs-string">'index'</span>)
    dispatcher.dispatch(<span class="hljs-string">'POST /action'</span>, <span class="hljs-string">'action'</span>)
    dispatcher.dispatch(<span class="hljs-string">'GET /health'</span>, <span class="hljs-string">'health'</span>)
    <span class="hljs-keyword">this</span>.dispatcher = dispatcher
}

Chaperon.prototype.index = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Compassion Chaperon API\n'</span>
})

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Group</span> (<span class="hljs-params">groupBy, collection, array</span>) </span>{
    <span class="hljs-keyword">var</span> groups = []
    array.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">element</span>) </span>{
        <span class="hljs-keyword">var</span> group = groups.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">group</span>) </span>{
            <span class="hljs-keyword">return</span> group[groupBy] == element[groupBy]
        }).shift()
        <span class="hljs-keyword">if</span> (!group) {
            group = {}
            group[groupBy] = element[groupBy]
            group[collection] = []
            groups.push(group)
        }
        group[collection].push(element)
    })
    <span class="hljs-keyword">this</span>.array = groups
    <span class="hljs-keyword">this</span>.map = {}
    <span class="hljs-keyword">this</span>.null = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">this</span>.array.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">group</span>) </span>{
        <span class="hljs-keyword">if</span> (group[groupBy] == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">this</span>.null = group
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.map[group[groupBy]] = group
        }
    }, <span class="hljs-keyword">this</span>)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">comparator</span> (<span class="hljs-params">keys</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>{
        <span class="hljs-keyword">var</span> compare = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = keys.length; i &lt; I; i++) {
            <span class="hljs-keyword">var</span> key = keys[i]
            <span class="hljs-keyword">var</span> compare = a[key] &lt; b[key] ? <span class="hljs-number">-1</span> : a[key] &gt; b[key] ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>
            <span class="hljs-keyword">if</span> (compare != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">break</span>
            }
        }
        <span class="hljs-keyword">return</span> compare
    }
}

</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>If we have been stable in machine count and availablity for more than thirty
seconds, then if we have an unrecoverable Paxos island, let’s reboot the
consensus, otherwise look for machines that are not part of stable island..</p>

            </div>

            <div class="content"><div class='highlight'><pre>
Chaperon.prototype._maybeAction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleagues, request, now</span>) </span>{
    <span class="hljs-keyword">var</span> colleagues = colleagues.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague</span>) </span>{
        <span class="hljs-keyword">return</span> colleague.islandName = request.islandName
    })
    <span class="hljs-keyword">var</span> stablity = <span class="hljs-keyword">this</span>._stability[request.islandName]
    <span class="hljs-keyword">if</span> (stablity == <span class="hljs-literal">null</span>) {
        stablity = <span class="hljs-keyword">this</span>._stability[request.islandName] = { <span class="hljs-attr">lastChecked</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">previous</span>: [] }
    }
    <span class="hljs-keyword">var</span> current = colleagues.slice().map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague</span>) </span>{
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">key</span>: colleague.key, <span class="hljs-attr">startedAt</span>: colleague.startedAt }
    }).sort(comparator(<span class="hljs-string">'key'</span>, <span class="hljs-string">'startedAt'</span>))
    <span class="hljs-keyword">if</span> (current.length == stablity.previous.length
        &amp;&amp; current.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague, index</span>) </span>{
            <span class="hljs-keyword">return</span> stablity.previous[index] != <span class="hljs-literal">null</span>
                &amp;&amp; stablity.previous[index].key == colleague.key
                &amp;&amp; stablity.previous[index].startedAt == colleague.startedA
        }).length == current.length) {
        stablity.duration = now - stablity.lastChecked
    } <span class="hljs-keyword">else</span> {
        stablity.duration = <span class="hljs-number">0</span>
    }
    stablity.lastChecked = now
    stablity.previous = curren
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._stableAfter &lt;= stablity.duration) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._action(colleagues, request)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'unstable'</span>, <span class="hljs-attr">vargs</span>: [] }
    }
}

Chaperon.prototype._action = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleagues, request</span>) </span>{
    <span class="hljs-keyword">var</span> instances = colleagues.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague</span>) </span>{
        <span class="hljs-keyword">return</span> colleague.colleagueId == request.colleagueId
    })
    <span class="hljs-keyword">switch</span> (instances.length) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        <span class="hljs-keyword">if</span> (instances[<span class="hljs-number">0</span>].startedAt != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (instances[<span class="hljs-number">0</span>].islandId != request.islandId) {
                <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'garbled'</span>, <span class="hljs-attr">vargs</span>: [] }
            }
            <span class="hljs-keyword">return</span> reachable(instances[<span class="hljs-number">0</span>])
        }
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'unreachable'</span>, <span class="hljs-attr">vargs</span>: [] }
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'duplicates'</span>, <span class="hljs-attr">vargs</span>: [instances] }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reachable</span> (<span class="hljs-params">instance</span>) </span>{
        <span class="hljs-keyword">var</span> instances = <span class="hljs-keyword">new</span> Group(<span class="hljs-string">'islandId'</span>, <span class="hljs-string">'colleagues'</span>, colleagues)
        instances.array.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">instance</span>) </span>{
            instance.unrecoverable = instance.islandId == <span class="hljs-literal">null</span>
                || unrecoverable(instance.colleagues)
        })
</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Check for split brain. Let’s hope this doesn’t happen. Get all of the
island instances that are recoverable and assert that there is only
one such island instance.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> recoverable = instances.array.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">instance</span>) </span>{
            <span class="hljs-keyword">return</span> ! instance.unrecoverable
        })
        <span class="hljs-keyword">if</span> (recoverable.length &gt; <span class="hljs-number">1</span>) {
            logger.error(<span class="hljs-string">'splitBrain'</span>, { <span class="hljs-attr">$instances</span>: recoverable })
            recoverable.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">instance</span>) </span>{ instance.splitBrain = <span class="hljs-literal">true</span> })
            <span class="hljs-keyword">if</span> (request.islandId == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'splitBrain'</span>, <span class="hljs-attr">vargs</span>: [] }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (instances.map[request.islandId].splitBrain) {
                <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'splitBrain'</span>, <span class="hljs-attr">vargs</span>: [] }
            }
        }
        <span class="hljs-keyword">if</span> (request.islandId == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (recoverable.length == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">var</span> oldest = instances.null.colleagues.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>{
                    <span class="hljs-keyword">return</span> a.startedAt - b.startedA
                }).shift()
                <span class="hljs-keyword">if</span> (oldest.colleagueId == request.colleagueId) {
                    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'bootstrap'</span>, <span class="hljs-attr">vargs</span>: [] }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'unstable'</span>, <span class="hljs-attr">vargs</span>: [] }
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> leaderId = recoverable[<span class="hljs-number">0</span>].colleagues.sort(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>{
                    <span class="hljs-keyword">return</span> Monotonic.compare(b.promise, a.promise)
                })[<span class="hljs-number">0</span>].parliament[<span class="hljs-number">0</span>]
                <span class="hljs-keyword">var</span> leader = recoverable[<span class="hljs-number">0</span>].colleagues.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague</span>) </span>{
                    <span class="hljs-keyword">return</span> colleague.colleagueId == leaderId
                }).shift()
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-attr">name</span>: <span class="hljs-string">'join'</span>,
                    <span class="hljs-attr">vargs</span>: [{
                        <span class="hljs-attr">location</span>: leader.location,
                        <span class="hljs-attr">islandId</span>: leader.islandId,
                        <span class="hljs-attr">islandName</span>: leader.islandName,
                        <span class="hljs-attr">colleagueId</span>: leader.colleagueId
                    }]
                }
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (instances.map[request.islandId].unrecoverable) {
            <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'unrecoverable'</span>, <span class="hljs-attr">vargs</span>: [] }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'recoverable'</span>, <span class="hljs-attr">vargs</span>: [] }
        }
    }
}

Chaperon.prototype.action = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, request</span>) </span>{
    <span class="hljs-keyword">var</span> colleagues = {}
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._uptime.get(<span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
        <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">async</span>.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">machine</span>) </span>{
                <span class="hljs-keyword">if</span> (machine.health == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> []
                }
                <span class="hljs-keyword">async</span>.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">colleague</span>) </span>{
                    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                        <span class="hljs-keyword">this</span>._ua.fetch({
                            <span class="hljs-attr">url</span>: util.format(<span class="hljs-keyword">this</span>._health, machine.location),
                            <span class="hljs-attr">post</span>: colleague,
                            <span class="hljs-attr">log</span>: log,
                            <span class="hljs-attr">nullify</span>: <span class="hljs-literal">true</span>
                        }, <span class="hljs-keyword">async</span>())
                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{
                        <span class="hljs-keyword">if</span> (body != <span class="hljs-literal">null</span>) {
                            <span class="hljs-keyword">var</span> key = <span class="hljs-string">'['</span> + colleague.islandName + <span class="hljs-string">']'</span> + colleague.colleagueId
                            colleagues[key] = body
                        }
                    })
                })(machine.health.colleagues)
            })(response.machines)
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">mingle</span>: response,
                <span class="hljs-attr">colleagues</span>: colleagues
            }
        })
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
        <span class="hljs-keyword">var</span> transformed = transform(response)
        logger.trace(<span class="hljs-string">'transform'</span>, { <span class="hljs-attr">$request</span>: request.body, <span class="hljs-attr">$response</span>: response, <span class="hljs-attr">$transformed</span>: transformed })
        <span class="hljs-keyword">var</span> action = <span class="hljs-keyword">this</span>._maybeAction(transformed, request.body, <span class="hljs-built_in">Date</span>.now())
        logger.trace(<span class="hljs-string">'action'</span>, {
            <span class="hljs-attr">action</span>: { <span class="hljs-attr">name</span>: action.name, <span class="hljs-attr">$vargs</span>: action.vargs },
            <span class="hljs-attr">$colleague</span>: request.body
        })
        <span class="hljs-keyword">return</span> action
    })
})

Chaperon.prototype.health = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> health = { <span class="hljs-attr">http</span>: <span class="hljs-keyword">this</span>.dispatcher.turnstile.health }
    logger.info(<span class="hljs-string">'health'</span>, health)
    <span class="hljs-keyword">return</span> health
})

<span class="hljs-built_in">module</span>.exports = Chaperon

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
